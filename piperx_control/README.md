# WidowX Master to PiperX Puppet Teleoperation

This directory contains the scripts needed to use a WidowX arm as a master controller for a PiperX puppet arm using the proper PiperX SDK.

## Files

### Core Scripts
- `relay_master_widowx.py` - Basic master controller script (dual-arm)
- `relay_master_widowx_flexible.py` - **Enhanced master with single-arm support and flexible options**
- `puppet_follow_piperx.py` - Basic puppet controller script (dual-arm)
- `puppet_follow_piperx_flexible.py` - **Enhanced puppet with single-arm support and tunable responsiveness**

### Supporting Scripts
- `robot_mapper.py` - Joint mapping logic between WidowX and PiperX with proper unit conversion
- `packing_utils_widowx_piperx.py` - UDP data serialization with bandwidth optimization
- `widowx_calibrate.py` - Script to calibrate WidowX arm
- `test_mapper.py` - Test script for joint mapping
- `test_piperx_neutral.py` - Test script for PiperX neutral positions
- `piperx_demo.py` - Simple demo using PiperX SDK
- `piperx_demo_continuous.py` - Continuous movement demo

### Configuration Files
- `widowx_calibration.json` - WidowX calibration data (generated by calibration script)
- `piperx_calibration.json` - PiperX calibration data with realistic limits
- `constants.py` - System constants and parameters
- `robot_utils.py` - Robot utility functions

## Prerequisites

### PiperX SDK Installation

You must install the PiperX SDK before using these scripts:

```bash
pip install piper-sdk
```

### Hardware Requirements

- WidowX master arm (wx250s) with USB connection
- PiperX puppet arm with CAN interface
- CAN-to-USB adapters for PiperX
- Optional: Stepper motor controller (Arduino-based)
- Optional: Mobile base robot
- Network connection between master and puppet computers

## Technical Details

### Unit Conversion System

The system handles different unit conventions between the two robots:

**WidowX (Master)**:
- Joint angles: **radians** (floating point)
- Gripper: **radians** (floating point)
- Range: typically -π to +π

**PiperX (Puppet)**:
- Joint angles: **degrees × 1000** (integer)
- Gripper: **degrees × 1000** (integer)  
- Example: 45° = 45000 in PiperX units

**Conversion Formula**:
```python
# WidowX radians → PiperX degrees*1000
piperx_value = widowx_radians * 180.0 / π * 1000

# PiperX degrees*1000 → WidowX radians  
widowx_radians = piperx_value / 1000.0 * π / 180.0
```

### UDP Heartbeat System

The system uses a bandwidth-optimized UDP protocol:

**Heartbeat Cycle** (4 packets):
- **Heartbeat 0**: Left arm joints 1-3
- **Heartbeat 1**: Left arm joints 4-6 + left gripper
- **Heartbeat 2**: Right arm joints 1-3  
- **Heartbeat 3**: Right arm joints 4-6 + right gripper

**Data Flow**:
1. Master sends partial joint data per packet
2. Puppet receives and unpacks data
3. Missing joints in current packet are `None`
4. Puppet only updates joints with non-`None` values
5. Smoothing continues for all joints at fixed 50Hz

**Packet Structure**:
```python
{
    'heartbeat': 0-3,           # Packet type
    'j1l': scaled_value,        # Joint 1 left (if in this heartbeat)
    'gl': scaled_gripper,       # Gripper left (if in this heartbeat)
    'key_mask': bitmask,        # Keyboard states
    'session_id': uuid,         # Session identifier
    'single_arm': boolean       # Single-arm mode flag
}
```

### Smoothing and Responsiveness

The puppet applies exponential smoothing for stable motion:

```python
# Smoothing formula (applied at 50Hz)
smoothed_position = α × target_position + (1-α) × previous_smoothed_position
```

**Smoothing Alpha Values**:
- **α = 0.1**: Very smooth, slow response (high lag)
- **α = 0.3**: Balanced smooth response
- **α = 0.8**: **Default** - responsive with minimal lag
- **α = 1.0**: No smoothing, direct response (may be jerky)

**Tunable via Command Line**:
```bash
python puppet_follow_piperx_flexible.py --smoothing-alpha 0.5
```

### Joint Mapping System

The `robot_mapper.py` handles coordinate transformation:

**Mapping Process**:
1. **Normalize**: Convert master joint to neutral-relative value (-1 to +1)
2. **Scale**: Map to puppet's range relative to its neutral position
3. **Convert Units**: radians → degrees × 1000

**Calibration-Based Mapping**:
- Uses `pos1` and `pos2` positions (not min/max limits)
- Neutral position acts as the mapping center point
- Preserves proportional relationships between robots

**None Value Handling**:
- Input `None` → Output `None` (preserves heartbeat system)
- Prevents crashes in UDP bandwidth optimization
- Allows selective joint updates

## Setup Instructions

### 1. Configure CAN Network (PiperX Side)

```bash
# Set up CAN interfaces for PiperX
sudo ip link set can0 type can bitrate 1000000
sudo ip link set can1 type can bitrate 1000000  # For dual-arm
sudo ip link set up can0
sudo ip link set up can1

# Verify CAN interfaces
ip link show can0
ip link show can1
```

### 2. Test PiperX Connection

```bash
cd piperx_control
python piperx_demo.py                    # Basic connection test
python test_piperx_neutral.py           # Test neutral positions
```

### 3. Calibrate WidowX Master

```bash
cd piperx_control
python widowx_calibrate.py
```

This generates `widowx_calibration.json` with:
- Joint limits for each joint
- Neutral positions 
- Gripper limits

### 4. Test Joint Mapping

```bash
cd piperx_control
python test_mapper.py
```

Verifies the coordinate transformation between robots.

### 5. Run Teleoperation

**Basic Dual-Arm Setup**:
```bash
# Master side (WidowX)
python relay_master_widowx.py

# Puppet side (PiperX) 
python puppet_follow_piperx.py
```

**Enhanced Flexible Setup**:
```bash
# Master side - single left arm with custom IP
python relay_master_widowx_flexible.py --single-arm --arm-side left --puppet-ip 192.168.1.100

# Puppet side - single arm with high responsiveness
python puppet_follow_piperx_flexible.py --single-arm --smoothing-alpha 0.9
```

## Advanced Usage

### Single-Arm Mode

Both master and puppet support single-arm operation:

```bash
# Master: Use only left arm
python relay_master_widowx_flexible.py --single-arm --arm-side left

# Master: Use only right arm  
python relay_master_widowx_flexible.py --single-arm --arm-side right

# Puppet: Accept single-arm data
python puppet_follow_piperx_flexible.py --single-arm
```

### Hardware-Specific Options

```bash
# Disable unavailable hardware
python puppet_follow_piperx_flexible.py --no-stepper --no-base

# Custom CAN interfaces
python puppet_follow_piperx_flexible.py --can-left can2 --can-right can3
```

### Gripper Lock Mode

```bash
# Lock/unlock arms by closing grippers during teleoperation
python relay_master_widowx_flexible.py --gripper-lock-left --gripper-lock-right
```

### Network Configuration

```bash
# Custom puppet IP address
python relay_master_widowx_flexible.py --puppet-ip 10.0.0.50
```

## Joint Mapping Reference

### WidowX → PiperX Joint Correspondence

| WidowX Joint | PiperX Joint | Description |
|--------------|--------------|-------------|
| waist | joint_1 | Base rotation |
| shoulder | joint_2 | Shoulder pitch |
| elbow | joint_3 | Elbow pitch |
| forearm_roll | joint_4 | Forearm roll |
| wrist_angle | joint_5 | Wrist pitch |
| wrist_rotate | joint_6 | Wrist roll |

### Calibration Data Format

**WidowX Calibration** (`widowx_calibration.json`):
```json
{
  "joint_limits": [
    [-2.094, 2.094],    // waist: ±120°
    [-1.745, 1.745],    // shoulder: ±100° 
    // ... more joints
  ],
  "neutral_positions": [0.0, -0.96, 1.16, 0.0, -0.3, 0.0],
  "gripper_limits": [-0.4, 1.0]
}
```

**PiperX Calibration** (`piperx_calibration.json`):
```json
{
  "joint_limits": [
    [-150000, 150000],   // joint_1: ±150° × 1000
    [0, 180000],         // joint_2: 0° to 180° × 1000
    // ... more joints  
  ],
  "neutral_positions": [-174, 9534, -3476, -5514, 2362, 505],
  "gripper_limits": [-770, 0]
}
```

## Communication Protocol

### Session Management

- Each teleoperation session has a unique `session_id`
- Puppet ignores packets from different sessions
- Prevents interference from multiple masters

### Initialization Handshake

1. **Master**: Sends `init_request` packet
2. **Puppet**: Responds with `init_ack`
3. **Master**: Sends `init` packet with initial positions  
4. **Puppet**: Moves to initial pose, responds with `init_ack`
5. **Teleoperation**: Begins continuous UDP streaming

### Error Handling

- **Packet Loss**: Puppet continues smoothing with last known targets
- **Network Timeout**: Puppet maintains last position
- **None Values**: Preserved through mapping for heartbeat system
- **Hardware Failures**: Graceful degradation with mock controllers

## Troubleshooting

### Common Issues

1. **"TypeError: 'NoneType' is not subscriptable"**
   - **Fixed**: Single-arm mode now handles inactive arms properly
   
2. **"No confirmation yet, resending..."**
   - **Fixed**: Puppet acknowledgment protocol corrected

3. **Unresponsive/Laggy Control**
   - **Solution**: Increase `--smoothing-alpha` (try 0.8-0.9)

4. **Robot Mapper Crashes**
   - **Fixed**: Proper None value handling in heartbeat system

### Network Debugging

```bash
# Check UDP traffic
sudo tcpdump -i any port 5005

# Test connectivity
ping [PUPPET_IP]

# Check port availability  
netstat -ulnp | grep 5005
```

### Hardware Debugging

```bash
# Check CAN interfaces
ip link show can0
candump can0

# Check WidowX connection
python -c "from interbotix_xs_modules.arm import InterbotixManipulatorXS; arm = InterbotixManipulatorXS('wx250s')"

# Check PiperX connection
python -c "from piper_sdk import C_PiperInterface_V2; p = C_PiperInterface_V2('can0')"
```

## Performance Notes

- **Control Frequency**: 50Hz (20ms cycle time)
- **UDP Bandwidth**: ~200 bytes/packet × 30Hz = ~6KB/s
- **Heartbeat Optimization**: Reduces bandwidth by 75%
- **Joint Smoothing**: Prevents mechanical stress and oscillations
- **Session Isolation**: Prevents packet interference

## Safety Considerations

- Always calibrate both robots before teleoperation
- Test joint mapping in safe environment first
- Use appropriate smoothing for your application
- Ensure emergency stops are accessible
- Monitor for mechanical interference or collisions
- Validate joint limits in calibration files

## Development Notes

The flexible scripts provide a solid foundation for:
- Custom robot integrations
- Different arm configurations  
- Hardware abstraction layers
- Protocol extensions
- Performance tuning

Key design patterns:
- Graceful hardware degradation
- Modular component architecture
- Comprehensive error handling
- Bandwidth-optimized communication
- Calibration-driven mapping 